---
title: "Impact du CO2 sur la température de la planète"
output:
  html_document: default
  pdf_document: default
---

Pour de l'aide sur R Markdown on peut aller sur 

http://rmarkdown.rstudio.com>

https://lms.fun-mooc.fr/c4x/UPSUD/42001S02/asset/RMarkdown.html

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 6, fig.height = 6)
```

## Introduction

On s'intéresse à la dépendance entre la température de surface de la planète et les émissions de C02 et leurs évolutions dans le temps. L'analyse de la température de surface GISS ver. 4 (GISTEMP v4) est une estimation du changement global de la température de surface. Les données proviennent de NOAA GHCN v4 (stations météorologiques) et ERSST v5 (zones océaniques). Plus de détails sont accessibles sur ce lien https://data.giss.nasa.gov/gistemp/.
Concernant le CO2, il est mesuré sur le Mauna Loa (sommet de l'archipel d'Hawai) depuis la fin des annnées 50. Détails sur https://gml.noaa.gov/ccgg/trends/

Le fichier "climat_CO2.txt" contient 3 colonnes : 

- **year** : années entre 1959 et 2020

- **CO2** : CO2 exprimé en fraction molaire dans l'air sec, micromol/mol, abrégé en ppm. Voir www.esrl.noaa.gov/gmd/ccgg/trends/ pour plus de détails.

- **gistemp** : anomalies de température en dégrés Celsius. Il s'agit des écarts entre la température annuelle et la température moyenne de la période 1951-1980.

## 1 - On commence par lire et visualiser les données du fichier


```{r}
CO2 = read.table(file = "climat_CO2.txt", header = TRUE)
head(CO2)
pairs(CO2)
plot(CO2$year,CO2$CO2)
plot(gistemp~CO2, data = CO2)
```

On remarque que l'objet CO2 est une structure de données. L'accès aux différents champs se fait avec le $. 
Mais la table CO2 peut aussi être utilisée comme une matrice. 
Les commandes pour accéder à une colonne, à une ligne, à un set d'indices sont alors les suivantes :

```{r}
CO2[,3]
CO2[30,]
indices = CO2$gistemp>0.5
CO2[indices,2]
CO2[c(12, 35, 50),]
```

## 2 - On met en place un modèle de régression de la température en fonction du CO2

La commande summary permet d'avoir accès aux estimations des paramètres et aux tests statistiques.
La commande plot permet l'analyse des résidus.

```{r}
mod1 = lm(gistemp~CO2, data = CO2)
summary(mod1)
par(mfrow=c(2,2))
plot(mod1)
```

```{r}
plot(gistemp~CO2, data = CO2)
abline(mod1$coefficients, col = 'red')
```


## 3 - Prédiction du modèle 

### La prédiction aux points d'observation

Le champ *fitted.values* de l'objet *CO2* contient les valeurs de  $\hat{y}_i , \forall i \in \{1, ..., n\}$ . 

```{r}
plot(CO2$gistemp ,mod1$fitted.values)
```

On considère que les résidus traduisent un bruit de mesure. 
Question : quelle est la donnée ayant la plus grande erreur de mesure ? 

```{r}
ecarts = abs(CO2$gistemp -mod1$fitted.values)
indice = ecarts == max(ecarts)
CO2[indice,]
c(CO2$gistemp[indice] ,mod1$fitted.values[indice])
```

### La prédiction en dehors des points d'observation

On utilise la fonction *predict* sur un seul point :

```{r}
nouvel_individu = data.frame(CO2 = 380)
prediction = predict(mod1, newdata = nouvel_individu)
plot(gistemp~CO2, data = CO2)
abline(mod1$coefficients, col = 'red')
points(nouvel_individu$CO2,prediction,col ="blue", pch = 19)
```

On peut aussi obtenir les intervalles de confiance et de prédiction :
```{r}
prediction_IC = data.frame(predict(mod1, newdata = nouvel_individu, interval = 'confidence', level = 0.95))
prediction_IC
plot(gistemp~CO2, data = CO2)
abline(mod1$coefficients, col = 'red')
points(nouvel_individu$CO2,prediction_IC$fit,col ="blue", pch = 19)
points(nouvel_individu$CO2,prediction_IC$lwr,col ="blue", pch = 19)
points(nouvel_individu$CO2,prediction_IC$upr,col ="blue", pch = 19)

prediction_IP = data.frame(predict(mod1, newdata = nouvel_individu, interval = 'prediction', level = 0.95))
points(nouvel_individu$CO2,prediction_IP$lwr,col ="blue", pch = 19)
points(nouvel_individu$CO2,prediction_IP$upr,col ="blue", pch = 19)


```

```{r}
CO2_bis = read.table(file = "climat_CO2.txt", header = TRUE)
head(CO2_bis)
pairs(CO2_bis)
plot(CO2_bis$year,CO2_bis$CO2)
plot(gistemp~CO2, data = CO2_bis)
```


```{r}

mod2 = lm(CO2 ~ I(year^2) + year, data = CO2_bis)
summary(mod2)
par(mfrow=c(2,2))
plot(mod2)
```

```{r}
df = data.frame(year = seq(2020,20250))
prediction = predict(mod2, newdata = df)
plot(CO2_bis$year, CO2_bis$CO2, main = "Ajustement quadratique", xlab = "Year", ylab = "CO2",ylim =c(300,500),xlim = c(2000, 2050))
points(df$year,prediction,col ="blue", pch = 19)
```

```{r}
new_ind = data.frame(year = seq(1900,2050))
pred_2050_CO2 = data.frame(CO2 =predict(mod2, newdata = new_ind))
pred_temp_2050 = predict(mod1, newdata = pred_2050_CO2)
pred_temp_2050
```

```{r}
prediction_IP = data.frame(predict(mod2, newdata = new_ind, interval = 'prediction', level = 0.95))
prediction_IP
int_cf_lwr =data.frame(CO2 =c(prediction_IP$lwr))
int_cf_upr =data.frame(CO2 =c(prediction_IP$upr))
int_cf_fit =data.frame(CO2 =c(prediction_IP$fit))
prediction_IP2_lwr = data.frame(predict(mod1, newdata = int_cf_lwr, interval = 'prediction', level = 0.95))
prediction_IP2_upr = data.frame(predict(mod1, newdata = int_cf_upr, interval = 'prediction', level = 0.95))
prediction_IP2_fit = data.frame(predict(mod1, newdata = int_cf_fit, interval = 'prediction', level = 0.95))
prediction_IP2_upr
plot(year~CO2, data = CO2)
abline(mod1$coefficients, col = 'red')
lines(new_ind,prediction_IP2_fit$fit,col ="blue", lty = 2)
lines(new_ind,prediction_IP2_lwr$lwr,col ="blue", lty = 2)
lines(new_ind,prediction_IP2_upr$upr,col ="blue", lty = 2)

````

points(prediction_IP$fit,prediction_IP2$fit,col ="blue", pch = 2)
points(prediction_IP$fit,prediction_IP2$lwr,col ="blue", pch = 2)
points(prediction_IP$fit,prediction_IP2$upr,col ="blue", pch = 2)


